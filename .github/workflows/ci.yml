name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        compiler: [gcc, clang]
        build_type: [Debug, Release]
        include:
          - compiler: gcc
            cxx_compiler: g++-12
            c_compiler: gcc-12
          - compiler: clang
            cxx_compiler: clang++-16
            c_compiler: clang-16

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build doxygen

    - name: Configure build
      run: |
        mkdir build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx_compiler }} \
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }} \
          -DCMAKE_CXX_STANDARD=20 \
          -DEVENTBUS_BUILD_EXAMPLES=ON \
          -G Ninja

    - name: Build library
      run: |
        cd build
        ninja

    - name: Run examples (smoke test)
      run: |
        cd build
        # Run a few key examples to ensure they work
        ./examples/basic_sync/basic_sync
        ./examples/async_exception_safety/async_exception_safety

    - name: Build examples target
      run: |
        cd build
        ninja build_all_examples

    - name: Test installation
      run: |
        cd build
        sudo ninja install
        # Verify installation
        ls -la /usr/local/include/eventbus/
        ls -la /usr/local/lib/cmake/eventbus/

    - name: Generate documentation
      run: |
        cd build
        ninja docs
        # Verify documentation was generated
        ls -la docs/html/index.html
